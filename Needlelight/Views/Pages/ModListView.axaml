<views:View x:TypeArguments="viewModels:ModListViewModel"
            xmlns="https://github.com/avaloniaui"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:models="clr-namespace:Needlelight.Models"
            xmlns:viewModels="clr-namespace:Needlelight.ViewModels"
            xmlns:views="clr-namespace:Needlelight.Views"
            xmlns:pages="clr-namespace:Needlelight.Views.Pages"
            xmlns:enums="clr-namespace:Needlelight.Enums"
            xmlns:utils="clr-namespace:Needlelight.Util"
            xmlns:customControls="clr-namespace:Needlelight.Views.Controls"
            xmlns:ext="clr-namespace:Needlelight.Extensions"
            xmlns:md="clr-namespace:Markdown.Avalonia;assembly=Markdown.Avalonia"
            xmlns:progRing="clr-namespace:AvaloniaProgressRing;assembly=AvaloniaProgressRing"
            mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="550"
            x:Class="Needlelight.Views.Pages.ModListView"
            x:DataType="viewModels:ModListViewModel"
            x:CompileBindings="True"
            Name="UserControl"
            KeyDown="OnKeyDown">
    <UserControl.Styles>
        <!-- Hard-disable hover visuals in Mods view -->
        <Style Selector="Expander /template/ ToggleButton#PART_Toggle">
            <Setter Property="Transitions"><Transitions/></Setter>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
        </Style>
        <Style Selector="Expander /template/ ToggleButton#PART_Toggle:pointerover">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
        </Style>
        <!-- Remove hover visuals in mod list items (keep sidebar hover only) -->
        <Style Selector="Expander">
            <Setter Property="Background" Value="{DynamicResource Brush.Surface}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource Brush.BorderSubtle}"/>
            <Setter Property="Transitions"><Transitions/></Setter>
        </Style>
        <Style Selector="Expander:pointerover">
            <Setter Property="Background" Value="{DynamicResource Brush.Surface}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource Brush.BorderSubtle}"/>
        </Style>
    </UserControl.Styles>
    <SplitView
        DisplayMode="CompactOverlay"
        OpenPaneLength="{Binding PaneWidth}"
        CompactPaneLength="35"
        PaneBackground="{DynamicResource RegionColor}"
        Background="{DynamicResource RegionColor}"
        IsPaneOpen="{Binding PaneOpen, Mode=TwoWay}"
        PanePlacement="Left">
    <!-- Sidebar -->
        <SplitView.Pane>
            <Border
                PointerEntered="OpenPane"
                PointerExited="ClosePane"
                Background="{DynamicResource BackgroundColor}"
        BorderBrush="{DynamicResource Brush.BorderSubtle}"
                BorderThickness="0 1 0 0">
                <StackPanel
                    Margin="2 0 0 4"
                    HorizontalAlignment="Stretch"
                    Orientation="Vertical"
                    VerticalAlignment="Bottom">
                    <StackPanel.Styles>
                        <Style Selector="Button">
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="HorizontalAlignment" Value="Stretch" />
                            <Setter Property="HorizontalContentAlignment" Value="Left" />
                            <Setter Property="ToolTip.ShowDelay" Value="0" />
                            <Setter Property="Margin" Value=" 0 5 0 0" />
                        </Style>
                        <Style Selector="PathIcon">
                            <Setter Property="Height" Value="20" />
                            <Setter Property="Width" Value="20" />
                            <Setter Property="Margin" Value="2 0 20 0" />
                        </Style>
                        <Style Selector="StackPanel">
                            <Setter Property="Orientation" Value="Horizontal" />
                        </Style>
                    </StackPanel.Styles>
                    <!-- Update All / Toggle buttons removed -->
                    <Button
                        Command="{Binding OpenSavesDirectory}">
                        <StackPanel>
                            <PathIcon Data="{StaticResource folder_zip_regular}" />
                            <TextBlock Text="{ext:Localize XAML_SavesFolder}" />
                        </StackPanel>
                    </Button>
                    <Button
                        Command="{Binding OpenModsDirectory}">
                        <StackPanel>
                            <PathIcon Data="{StaticResource folder_regular}" />
                            <TextBlock Text="{ext:Localize XAML_OpenMods}" />
                        </StackPanel>
                    </Button>
                    <Button
                        Command="{Binding OpenModlog}">
                        <StackPanel>
                            <PathIcon Data="{StaticResource book_database_regular}" />
                            <TextBlock Text="{ext:Localize XAML_Modlog}" />
                        </StackPanel>
                    </Button>
                    <Button
                        Command="{Binding ManuallyInstallMod}">
                        <StackPanel>
                            <PathIcon Data="{StaticResource arrow_download_regular}" />
                            <TextBlock Text="{ext:Localize XAML_Manual_Install}" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </SplitView.Pane>
    <DockPanel>



    <ProgressBar
        DockPanel.Dock="Bottom"

        MaxHeight="8"
        MinHeight="8"

        Margin="0 0 0 1"

        Name="Bar"

        IsVisible="{Binding ProgressBarVisible}"

        IsIndeterminate="{Binding ProgressBarIndeterminate}"

        Minimum="0"
        Maximum="100"
        Value="{Binding Progress}" />

    <Border
        BorderBrush="{DynamicResource Brush.BorderSubtle}"
        BorderThickness="0 0 0 1"
        DockPanel.Dock="Top">
        <DockPanel>
            <Menu
                DockPanel.Dock="{Binding ModFilterDocking}"
                HorizontalAlignment="Stretch">

                <Menu.Styles>
                    <Style Selector="MenuItem">
                        <Setter Property="Padding" Value="6 0" />
                    </Style>
                </Menu.Styles>

                <!-- The PointerPressed un highlights all the filter buttons except the one that's pressed
                    the name prefix "ModFilter_" helps find all buttons in code behind. The All button is
                    highlighted by default on app open-->
                <MenuItem
                    IsEnabled="False"
                    Header="{ext:Localize XAML_FilterMods}" />

                <MenuItem
                    Name="ModFilter_All"
                    IsVisible="{Binding IsInOnlineMode}"
                    Header="{ext:Localize XAML_ModsFilter_All}"
                    Command="{Binding SelectModsWithFilter}"
                    CommandParameter="{x:Static enums:ModFilterState.All}" />

                <MenuItem
                    Name="ModFilter_Installed"
                    Header="{ext:Localize XAML_ModsFilter_Installed}"
                    Command="{Binding SelectModsWithFilter}"
                    CommandParameter="{x:Static enums:ModFilterState.Installed}" />

                <MenuItem
                    Name="ModFilter_Enabled"
                    Header="{ext:Localize XAML_ModsFilter_Enabled}"
                    Command="{Binding SelectModsWithFilter}"
                    CommandParameter="{x:Static enums:ModFilterState.Enabled}" />

            </Menu>
            <StackPanel>
                <Grid
                    IsVisible="{Binding !IsInWhatsNew}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MinWidth="400" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBox
                        Grid.Column="0"
                        x:Name="Search"
                        Name="Search"
                        IsVisible="{ReflectionBinding $parent[pages:ModListView].DataContext.IsNormalSearch}"
                        Watermark="{ext:Localize XAML_SearchMark}"
                        BorderThickness="0"
                        Margin="6 6"
                        Text="{Binding Search}" />

                    <AutoCompleteBox
                        Grid.Column="0"
                        IsVisible="{ReflectionBinding $parent[pages:ModListView].DataContext.IsDependencyAndIntegrationSearch}"
                        BorderThickness="0"
                        Margin="6 6"
                        SelectedItem="{Binding DependencySearchItem}"
                        ItemsSource="{Binding ModNames}" />

                    <AutoCompleteBox
                        Grid.Column="0"
                        IsVisible="{ReflectionBinding $parent[pages:ModListView].DataContext.IsIntegrationSearch}"
                        BorderThickness="0"
                        Margin="6 6"
                        SelectedItem="{Binding DependencySearchItem}"
                        ItemsSource="{Binding ModNames}" />

                    <Button
                        Grid.Column="1"
                        Background="Transparent"
                        HorizontalAlignment="Right"
                        BorderThickness="0"
                        IsVisible="{Binding ClearSearchVisible}"
                        Command="{Binding ClearSearch}"
                        Margin="0 0 0 0">
                        <PathIcon
                            Data="{StaticResource presence_offline_regular}"
                            Width="15" Height="15" />
                    </Button>

                </Grid>
            </StackPanel>
        </DockPanel>
    </Border>

    <TextBlock
        DockPanel.Dock="Top"
        Margin="0 -25 10 0"
        VerticalAlignment="Top"
        HorizontalAlignment="Right"
        Text="{Binding NumberOfResults}"
        Foreground="{DynamicResource DisabledColor}"/>

    <ScrollViewer>
      <StackPanel>
        <Grid IsVisible="{Binding !LoadedWhatsNew}"
              ColumnDefinitions="Auto *"
              RowDefinitions="3*, *">

          <progRing:ProgressRing
              IsVisible="{Binding IsLoadingWhatsNew}"
              Grid.Row="0" Grid.Column="0"
              Grid.ColumnSpan="2"
              Width="100"
              Height="100"
              IsActive="True"
              HorizontalAlignment="Center"
              VerticalAlignment="Center"
              Foreground="Ivory"
              Margin="10,20,0,0"/>

          <PathIcon
              Grid.Column="0"
              Grid.Row="1"
              IsVisible="{Binding ShouldShowWhatsNewErrorIcon}"
              Margin="30,40,10,0"
              Data="{StaticResource warning_regular}"
              Height="50" Width="50"/>

          <TextBlock
              Grid.Row="1"
              Grid.Column="1"
              Margin="20,40,0,0"
              TextWrapping="Wrap"
              IsVisible="{Binding ShouldShowWhatsNewInfoText}"
              Text="{Binding WhatsNewLoadingText}"
              FontSize="16"
              VerticalAlignment="Center"/>
        </Grid>
                        <!-- Centered empty-state banner when no items match (bigger, red-highlighted) -->
            <Grid IsVisible="{Binding NoFilteredItems}" MinHeight="420">
                            <Border
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Padding="32"
                                    CornerRadius="10"
                    Background="{DynamicResource Brush.SurfaceElevated}"
                    BorderBrush="{DynamicResource Brush.BorderSubtle}"
                                    BorderThickness="2">
                                <StackPanel Orientation="Horizontal" Spacing="16" HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <PathIcon Data="{StaticResource dismiss_circle_regular}" Width="36" Height="36" Foreground="{DynamicResource Brush.Accent}"/>
                                    <TextBlock
                                            Text="{ext:Localize XAML_No_Items}"
                                            FontSize="28"
                                            FontWeight="Bold"
                        Foreground="{DynamicResource Brush.TextPrimary}"/>
                                </StackPanel>
                            </Border>
                        </Grid>

                <!-- Success notification when What's New has loaded: maroon background + green tick -->
        <Border
                        IsVisible="{Binding LoadedWhatsNew}"
                        Margin="0 8 0 8"
                        Padding="14"
                        CornerRadius="6"
            Background="{DynamicResource Brush.SurfaceElevated}"
            BorderBrush="{DynamicResource Brush.BorderSubtle}"
            BorderThickness="1">
                    <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                        <PathIcon Data="{StaticResource checkmark_circle_regular}"
                                            Width="20" Height="20"
                                            Foreground="#2ECC71"/>
            <TextBlock Text="Latest updates loaded."
                                             FontSize="14"
                                             Foreground="{DynamicResource Brush.TextPrimary}"/>
                    </StackPanel>
                </Border>

        <ItemsRepeater ItemsSource="{Binding FilteredItems}" ElementPrepared="PrepareElement" VerticalCacheLength="20">
          <ItemsRepeater.ItemTemplate>
            <DataTemplate DataType="models:ModItem">
              <Grid Margin="8 12 12 0">
                <Grid.ContextMenu>
                  <ContextMenu IsEnabled="{Binding IsModContextMenuEnabled}">
                    <MenuItem
                        IsEnabled="{Binding CanBePinned}"
                        Header="{ext:Localize XAML_Pin}"
                        Command="{ReflectionBinding $parent[pages:ModListView].DataContext.PinMod}"
                        CommandParameter="{Binding .}"
                        ToolTip.Tip="{ext:Localize XAML_PinMod_Explanation}" ToolTip.ShowDelay="0"/>
                    <MenuItem
                        IsEnabled="{Binding CanBeRegisteredNotInModlinks}"
                        Header="{ext:Localize XAML_RegisterNotInModlinks}"
                        Command="{ReflectionBinding $parent[pages:ModListView].DataContext.RegisterNotInModlinks}"
                        CommandParameter="{Binding .}"
                        ToolTip.Tip="{ext:Localize XAML_RegisterNotInModlinks_Explanation}" ToolTip.ShowDelay="0"/>
                  </ContextMenu>
                </Grid.ContextMenu>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" MaxWidth="260" />
                  <ColumnDefinition Width="3*" />
                </Grid.ColumnDefinitions>

                <Expander Grid.Column="0" Grid.ColumnSpan="2" HorizontalAlignment="Stretch" Background="{DynamicResource Brush.Surface}">
                  <Expander.Header>
                    <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition MaxWidth="40"/>   <!-- pin -->
                                            </Grid.ColumnDefinitions>
                      <TextBlock Grid.Column="0"
                          TextWrapping="Wrap"
                          VerticalAlignment="Center"
                          Margin="0 0 20 0"
                          Name="ModName"
                          Text="{Binding Name}"/>

                      <Panel
                          VerticalAlignment="Center"
                          Grid.Column="1">
                        <ToggleSwitch
                            Margin="0 -3 6 0"
                            VerticalAlignment="Top"
                            CommandParameter="{Binding .}"
                            OnContent="{ext:Localize XAML_On}"
                            OffContent="{ext:Localize XAML_Off}"
                            Command="{ReflectionBinding $parent[pages:ModListView].DataContext.OnEnable}"
                            IsChecked="{Binding EnabledIsChecked}"
                            IsEnabled = "{Binding EnableButtonAccessible}"
                            VerticalContentAlignment="Center"
                            HorizontalAlignment="Right"
                                                />
                      </Panel>
                      <Button Grid.Column="2"
                              Margin="0 -5 0 0"
                              VerticalAlignment="Center"
                              Background="Transparent"
                              BorderBrush="Transparent"
                              IsVisible="{Binding Pinned}"
                              ToolTip.Tip="{ext:Localize XAML_Unpin}" ToolTip.ShowDelay="0"
                              Command="{ReflectionBinding $parent[pages:ModListView].DataContext.PinMod}"
                              CommandParameter="{Binding .}"
                              HorizontalAlignment="Right">
                        <PathIcon
                             Data="{StaticResource pin_regular}"
                             FontSize="20"
                             Margin="1 5 0 0"
                             VerticalAlignment="Center"
                             HorizontalAlignment="Center"/>
                      </Button>
                    </Grid>
                  </Expander.Header>

                    <Grid
                        RowDefinitions="Auto, *, Auto"
                        ColumnDefinitions="*,*"
                        Margin="12 0 12 10">

                        <md:MarkdownScrollViewer
                            Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="0"
                            Markdown="{Binding Description}" Margin="0 0 4 0" />

                        <StackPanel
                            Grid.Column="0" Grid.Row="1"
                            IsVisible="{Binding HasRepo}"
                            Margin="0,10,10,0">

                            <TextBlock Text="{ext:Localize XAML_Version}" FontWeight="Bold" Margin="0 0 0 0" />
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding VersionText}" />
                            </StackPanel>

                            <StackPanel IsVisible="{Binding HasDependencies}" Margin="0 10 0 0">
                                <TextBlock Text="{ext:Localize XAML_Dependencies}" FontWeight="Bold" />
                                <TextBlock Text="{Binding DependenciesDesc}" TextWrapping="Wrap" />
                            </StackPanel>

                        </StackPanel>
                        <StackPanel Grid.Column="1" Grid.Row="1" HorizontalAlignment="Center" Margin="10,0,0,0">
                            <StackPanel IsVisible="{Binding HasAuthors}" Margin="0 10 0 0">
                                <TextBlock Text="{ext:Localize XAML_Authors}" FontWeight="Bold" />
                                <TextBlock Text="{Binding AuthorsDesc}" TextWrapping="Wrap" />
                            </StackPanel>
                            <StackPanel IsVisible="{Binding HasIntegrations}" Margin="0 10 0 0">
                                <TextBlock Text="{ext:Localize XAML_Integrations}" FontWeight="Bold" />
                                <TextBlock Text="{Binding IntegrationsDesc}" TextWrapping="Wrap" />
                            </StackPanel>
                            <StackPanel IsVisible="{Binding HasTags}" Margin="0 10 0 0">
                                <TextBlock Text="{ext:Localize XAML_Tags}" FontWeight="Bold" />
                                <TextBlock Text="{Binding TagDesc}" TextWrapping="Wrap" />
                            </StackPanel>
                        </StackPanel>
                        <StackPanel
                            Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                            HorizontalAlignment="Left"
                            Orientation="Horizontal"
                            Margin="0 10 0 0">
                            <StackPanel.Styles>
                                <Style Selector="Button.Icon">
                                    <Setter Property="Width" Value="25" />
                                    <Setter Property="Height" Value="25" />
                                </Style>
                                <Style Selector="Button">
                                    <Setter Property="Margin" Value="0 0 10 0" />
                                </Style>
                            </StackPanel.Styles>
                            <Button Content="{ext:Localize ViewReadme}"
                                    Command="{Binding OpenReadme}"/>
                            <Button
                                Classes="Icon"
                                ToolTip.Tip="{ext:Localize XAML_Repository}" ToolTip.ShowDelay="0"
                                Command="{Binding OpenRepository}">
                                <Svg Path="../../Assets/github.svg" Width="20" Height="20"/>
                            </Button>
                            <Button
                                Classes="Icon"
                                ToolTip.Tip="{ext:Localize XAML_Share}" ToolTip.ShowDelay="0"
                                Command="{Binding Share}">
                                <PathIcon Data="{StaticResource share_android_regular}" />
                            </Button>
                            <Button
                                Classes="Icon"
                                ToolTip.Tip="{ext:Localize XAML_OpenFolder}" ToolTip.ShowDelay="0"
                                IsEnabled="{Binding Installed}"
                                Command="{ReflectionBinding $parent[pages:ModListView].DataContext.OpenFolder}"
                                CommandParameter="{Binding .}">
                                <PathIcon Data="{StaticResource folder_regular}" />
                            </Button>
                            <Button
                                ToolTip.Tip="{ext:Localize XAML_ResetMod}" ToolTip.ShowDelay="0"
                                IsEnabled="{Binding Installed}"
                                Command="{ReflectionBinding $parent[pages:ModListView].DataContext.ResetMod}"
                                CommandParameter="{Binding .}">
                                <PathIcon Data="{StaticResource history_regular}" Width="16" Height="16"/>
                            </Button>
                            <Button
                                Classes="Icon"
                                ToolTip.Tip="{ext:Localize XAML_EditSettings}" ToolTip.ShowDelay="0"
                                IsEnabled="{Binding HasSettings}"
                                Command="{Binding OpenSettingsFile}">
                                <PathIcon Data="{StaticResource edit_settings_regular}" />
                            </Button>
                            <Button
                                Classes="Icon"
                                ToolTip.Tip="{ext:Localize XAML_ReportBug}" ToolTip.ShowDelay="0"
                                Command="{Binding ReportBug}">
                                <PathIcon Data="{StaticResource bug_regular}" />
                            </Button>
                        </StackPanel>
                  </Grid>
                </Expander>
              </Grid>
            </DataTemplate>
          </ItemsRepeater.ItemTemplate>
        </ItemsRepeater>
      </StackPanel>
    </ScrollViewer>
  </DockPanel>
  </SplitView>
</views:View>

